name: Release to PRODUCTION

on:
  workflow_dispatch:
    inputs:
      semver:
        description: "Version bump"
        required: true
        type: choice
        default: none
        options:
          - none
          - patch
          - minor
          - major

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  # TODO:
  # test:
  #   name: Test
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Tests not implemented yet
  #       run: echo "No tests implemented yet"

  version:
    name: Resolve version
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.version.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: "0"

      - name: Resolve version tag
        id: version
        uses: anothrNick/github-tag-action@1.75.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_PREFIX: v
          PRERELEASE: ${{ inputs.semver == 'prerelease' }}
          DEFAULT_BUMP: ${{ inputs.semver }}
          PRERELEASE_SUFFIX: ${{ inputs.prefix }}
          DRY_RUN: true
          FORCE_WITHOUT_CHANGES: true

  build:
    name: Build
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the updated source code
        uses: actions/checkout@v4

      - name: Build Docker image
        uses: ./.github/actions/build-docker-image
        with:
          context: .
          image-name: interni-sekce
          retention-days: 1
          build-args: |
            VERSION=${{ needs.version.outputs.new_tag }}
            NG_CONFIGURATION=production

  publish:
    name: Publish
    needs:
      - build
      - version
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.publish.outputs.images }}
    steps:
      - name: Checkout the updated source code
        uses: actions/checkout@v4

      - name: Publish Docker image
        id: publish
        uses: ./.github/actions/publish-docker-image
        with:
          source-image-name: interni-sekce
          publish-image-name: bosancz/interni-sekce
          registry: ghcr.io
          tag: latest
          version: ${{ needs.version.outputs.new_tag }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Tell the watchtower server there is a new image
        env:
          WATCHTOWER_URL: ${{ vars.WATCHTOWER_URL }}/v1/update?image=${{ needs.publish.outputs.images }}
          WATCHTOWER_TOKEN: ${{ vars.WATCHTOWER_TOKEN }}
        run: 'curl --fail --header "Authorization: Bearer $WATCHTOWER_TOKEN" $WATCHTOWER_URL'

  tag:
    name: Tag environment
    needs:
      - version
      - deploy
    uses: ./.github/workflows/tag.yml
    with:
      tag: production
      version: ${{ needs.version.outputs.new_tag }}
